name: Veracode Template

on:
  workflow_call:
    inputs:
      build-id:
        description: 'ID da build'
        required: true
        type: string
      project_veracode:
        description: 'Project'
        required: true
        type: string
      environment:
        description: 'Environment'
        required: true
        type: string

env:
  project: ${{ inputs.project_veracode }}
  environment: ${{ inputs.environment }}

jobs:
  autopack:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do Código
        uses: actions/checkout@v4

      # Detecta se é um projeto Maven (verificando a existência do pom.xml)
      - name: Detectar Projeto Java-Maven
        id: check_maven
        run: |
          if [ -f "pom.xml" ]; then
            echo "java_maven=true" >> $GITHUB_ENV
          else
            echo "java_maven=false" >> $GITHUB_ENV
          fi

      # Detecta se é um projeto Gradle (verificando a existência de build.gradle ou build.gradle.kts)
      - name: Detectar Projeto Java-Gradle
        id: check_gradle
        run: |
          if [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            echo "java_gradle=true" >> $GITHUB_ENV
          else
            echo "java_gradle=false" >> $GITHUB_ENV
          fi

      # Para projetos Maven: extrai a versão do Java definida no pom.xml
      - name: Detectar versão do Java no pom.xml
        if: env.java_maven == 'true'
        id: detect_java_maven
        run: |
          # Tenta extrair o valor da tag <maven.compiler.source>; se não encontrar, usa "11"
          JAVA_VERSION=$(grep -oPm1 "(?<=<maven.compiler.source>)[^<]+" pom.xml || echo "11")
          echo "Versão do Java detectada (Maven): $JAVA_VERSION"
          echo "java_version_maven=$JAVA_VERSION" >> $GITHUB_OUTPUT

      # Para projetos Gradle: tenta extrair a versão do Java a partir de duas fontes:
      # 1. Pelo padrão em compileOptions (sourceCompatibility = JavaVersion.VERSION_xx)
      # 2. Se não encontrado, busca por uma propriedade javaVersion (por exemplo, em defaultConfig)
      # Além disso, se for projeto Android (detectado pelo bloco "android {"), forçamos o mínimo para 17.
      - name: Detectar versão do Java no Gradle
        if: env.java_gradle == 'true'
        id: detect_java_gradle
        run: |
          if [ -f "build.gradle" ]; then
            RAW_VERSION=$(grep -oP "sourceCompatibility\s*=\s*JavaVersion\.VERSION_(\d+(?:[_\.]\d+)?)" build.gradle | head -n1)
            if [ -z "$RAW_VERSION" ]; then
              # Tenta buscar por uma propriedade javaVersion, por exemplo: javaVersion = "11"
              RAW_VERSION=$(grep -oP "(?<=javaVersion\s*=\s*['\"])\d+(?=['\"])" build.gradle | head -n1)
            fi
            ANDROID_DETECTED=$(grep -qi "android\s*{" build.gradle && echo "true" || echo "false")
          elif [ -f "build.gradle.kts" ]; then
            RAW_VERSION=$(grep -oP "sourceCompatibility\s*=\s*JavaVersion\.VERSION_(\d+(?:[_\.]\d+)?)" build.gradle.kts | head -n1)
            if [ -z "$RAW_VERSION" ]; then
              RAW_VERSION=$(grep -oP "(?<=javaVersion\s*=\s*['\"])\d+(?=['\"])" build.gradle.kts | head -n1)
            fi
            ANDROID_DETECTED=$(grep -qi "android\s*{" build.gradle.kts && echo "true" || echo "false")
          else
            RAW_VERSION=""
            ANDROID_DETECTED="false"
          fi

          # Se RAW_VERSION estiver no padrão "sourceCompatibility = JavaVersion.VERSION_xx", extrai os números.
          if [[ "$RAW_VERSION" == JavaVersion.VERSION_* ]]; then
            MAJOR=$(echo "$RAW_VERSION" | sed -E 's/.*VERSION_([0-9]+)[_.]?.*/\1/')
            MINOR=$(echo "$RAW_VERSION" | sed -E 's/.*VERSION_[0-9]+[_.]?([0-9]*)/\1/')
            if [ "$MAJOR" = "1" ] && [ -n "$MINOR" ]; then
              JAVA_VERSION="$MINOR"
            else
              JAVA_VERSION="$MAJOR"
            fi
          else
            # Se RAW_VERSION já for apenas um número (por exemplo, extraído de javaVersion), use-o.
            JAVA_VERSION="$RAW_VERSION"
          fi

          if [ -z "$JAVA_VERSION" ]; then
            JAVA_VERSION="11"
          fi

          # Se for um projeto Android, forçamos o mínimo para 17.
          if [ "$ANDROID_DETECTED" = "true" ]; then
            if [ "$JAVA_VERSION" -lt 17 ]; then
              echo "Projeto Android detectado – forçando versão mínima do JDK para 17."
              JAVA_VERSION=17
            fi
          fi

          # Validação: se a versão não estiver entre as permitidas (7, 11, 17 ou 21), usamos um valor padrão.
          ALLOWED_VERSIONS=("7" "11" "17" "21")
          VALID="false"
          for v in "${ALLOWED_VERSIONS[@]}"; do
            if [ "$JAVA_VERSION" = "$v" ]; then
              VALID="true"
              break
            fi
          done

          if [ "$VALID" = "false" ]; then
            if [ "$ANDROID_DETECTED" = "true" ]; then
              echo "Projeto Android ou versão não suportada ($JAVA_VERSION) – forçando JDK 17."
              JAVA_VERSION="17"
            else
              echo "Versão do Java não suportada ($JAVA_VERSION) – utilizando JDK 11 como padrão."
              JAVA_VERSION="11"
            fi
          fi

          echo "Versão do Java detectada (Gradle): $JAVA_VERSION"
          echo "java_version_gradle=$JAVA_VERSION" >> $GITHUB_OUTPUT

      # Configura o JDK para projetos Maven (usando a versão detectada) e instala as dependências
      - name: Configurar JDK para Maven e instalar dependências
        if: env.java_maven == 'true'
        uses: actions/setup-java@v3
        with:
          java-version: ${{ steps.detect_java_maven.outputs.java_version_maven }}
          distribution: temurin
          cache: maven

      - name: Instalar dependências Maven
        if: env.java_maven == 'true'
        run: mvn dependency:resolve

      # Configura o JDK para projetos Gradle (usando a versão detectada) e instala as dependências
      - name: Configurar JDK para Gradle e instalar dependências
        if: env.java_gradle == 'true'
        uses: actions/setup-java@v3
        with:
          java-version: ${{ steps.detect_java_gradle.outputs.java_version_gradle }}
          distribution: temurin
          cache: gradle

      - name: Instalar dependências Gradle
        if: env.java_gradle == 'true'
        run: |
          chmod +x gradlew
          ./gradlew --no-daemon dependencies

      # Build do projeto Maven
      - name: Compilar Projeto Maven
        if: env.java_maven == 'true'
        run: mvn clean package

      # Build do projeto Gradle
      - name: Compilar Projeto Gradle
        if: env.java_gradle == 'true'
        run: |
          chmod +x gradlew
          ./gradlew clean build



      # Exemplo de etapa para preparar os artefatos para o Veracode (ajuste conforme sua necessidade)
      - name: Instalar CLI do Veracode e Autopack-Veracode
        run: |
          mkdir -p ${{ github.workspace }}/artifacts/${{ inputs.build-id }}
          
          # Define o diretório de saída de acordo com a ferramenta de build utilizada
          if [ "${{ env.java_maven }}" = "true" ]; then
            OUTPUT_DIR="target"
          elif [ "${{ env.java_gradle }}" = "true" ]; then
            OUTPUT_DIR="build/libs"
          else
            OUTPUT_DIR="."
          fi
          
          # Procura arquivos WAR, JAR ou ZIP no diretório de saída
          WAR_FILE=$(find $OUTPUT_DIR -maxdepth 1 -name "*.war" | head -n 1)
          JAR_FILE=$(find $OUTPUT_DIR -maxdepth 1 -name "*.jar" | head -n 1)
          
          echo "Arquivos encontrados: WAR: $WAR_FILE, JAR: $JAR_FILE"
      
          if [ -f "$WAR_FILE" ]; then
            echo "WAR encontrado: $WAR_FILE"
            # Copia o WAR para o diretório de artefatos com um nome fixo
            cp "$WAR_FILE" ${{ github.workspace }}/artifacts/${{ inputs.build-id }}/application.war
      
          elif [ -f "$JAR_FILE" ]; then
            echo "JAR encontrado: $JAR_FILE"
            cp "$JAR_FILE" ${{ github.workspace }}/artifacts/${{ inputs.build-id }}/application.jar
            # Compacta o JAR em um zip para padronizar, se necessário
      
          else
            echo "Nenhum WAR, JAR ou ZIP encontrado. Rodando Autopack..."
            curl -fsS https://tools.veracode.com/veracode-cli/install | sh
            ./veracode package --source . --output ${{ github.workspace }}/artifacts/${{ inputs.build-id }} --trust
      
            find ${{ github.workspace }}/artifacts/${{ inputs.build-id }} -name "*.zip" |
            while read filename; do unzip -o -d "$(dirname "$filename")" "$filename"; done
      
            rm -rf ${{ github.workspace }}/artifacts/${{ inputs.build-id }}/*.zip
            zip analysisPack.zip -r ${{ github.workspace }}/artifacts/${{ inputs.build-id }}
            mv analysisPack.zip ${{ github.workspace }}/artifacts/${{ inputs.build-id }}/analysisPack.zip
          fi

      - name: Publicar Artefato para Análise
        uses: actions/upload-artifact@v4
        with:
          name: analysisPack
          path: |
            ${{ github.workspace }}/artifacts/${{ inputs.build-id }}/analysisPack.zip
            ${{ github.workspace }}/artifacts/${{ inputs.build-id }}/application.jar
            ${{ github.workspace }}/artifacts/${{ inputs.build-id }}/application.war
            
          retention-days: 1

  sca:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Executar Veracode SCA
        continue-on-error: true
        env:
          SRCCLR_API_TOKEN: ${{ secrets.SCA }}
        run: |
          curl -sSL https://download.sourceclear.com/ci.sh | bash -s – scan --update-advisor --allow-dirty

  pipeline_scan:
    runs-on: ubuntu-latest
    needs: autopack
    steps:
      - name: Baixar Artefato para Análise
        uses: actions/download-artifact@v4
        with:
          name: analysisPack

      - name: Baixar Veracode Pipeline Scanner
        run: curl -O -L https://downloads.veracode.com/securityscan/pipeline-scan-LATEST.zip

      - name: Extrair Veracode Pipeline Scanner
        run: unzip pipeline-scan-LATEST.zip -d ${{ github.workspace }}/scanner

      - name: Executar Veracode Pipeline Scan
        id: pipeline_scan
        env:
          VID: ${{ secrets.APIID_VERACODE }}
          VKEY: ${{ secrets.APIKEY_VERACODE }}
        run: |
          # Procura pelo arquivo WAR
          WAR_FILE=$(find . -name "*.war" | head -n 1)
          # Procura pelo arquivo JAR (excluindo o pipeline-scan.jar)
          JAR_FILE=$(find . -name "*.jar" -not -name "pipeline-scan.jar" | head -n 1)
          
          if [ -f "$WAR_FILE" ]; then
            echo "Aplicação WAR detectada. Usando arquivo: $WAR_FILE"
            java -jar ${{ github.workspace }}/scanner/pipeline-scan.jar \
              -vid $VID -vkey $VKEY \
              --file "$WAR_FILE" --issue_details true --fail_on_severity="Very High, High"
          elif [ -f "$JAR_FILE" ]; then
            echo "Java build detectado. Usando arquivo: $JAR_FILE"
            java -jar ${{ github.workspace }}/scanner/pipeline-scan.jar \
              -vid $VID -vkey $VKEY \
              --file "$JAR_FILE" --issue_details true --fail_on_severity="Very High, High"
          else
            echo "Nenhum WAR ou JAR encontrado. Usando analysisPack.zip."
            java -jar ${{ github.workspace }}/scanner/pipeline-scan.jar \
              -vid $VID -vkey $VKEY \
              --file analysisPack.zip --issue_details true --fail_on_severity="Very High, High"
          fi

  sast:
    runs-on: ubuntu-latest
    needs: autopack
    steps:
      - name: Baixar Artefato para Análise SAST
        uses: actions/download-artifact@v4
        with:
          name: analysisPack

      - name: Baixar Veracode SAST Wrapper
        run: |
          curl -O -L https://repo1.maven.org/maven2/com/veracode/vosp/api/wrappers/vosp-api-wrappers-java/24.7.14.0/vosp-api-wrappers-java-24.7.14.0.jar

      - name: Executar Veracode SAST
        env:
          VID: ${{ secrets.APIID_VERACODE }}
          VKEY: ${{ secrets.APIKEY_VERACODE }}
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          # Verifica se existe um WAR
          WAR_FILE=$(find . -maxdepth 2 -name "*.war" | head -n 1)
          if [ -f "$WAR_FILE" ]; then
            echo "Aplicação WAR detectada. Usando arquivo: $WAR_FILE"
            ARTIFACT="$WAR_FILE"
          else
            # Se não houver WAR, procura por um JAR (excluindo o vosp-api-wrappers)
            JAR_FILE=$(find . -maxdepth 2 -name "*.jar" -not -name "vosp-api-wrappers*.jar" | head -n 1)
            if [ -f "$JAR_FILE" ]; then
              echo "Java build detectado. Usando arquivo: $JAR_FILE"
              ARTIFACT="$JAR_FILE"
            else
              echo "Nenhum WAR ou JAR encontrado. Usando analysisPack.zip."
              ARTIFACT="analysisPack.zip"
            fi
          fi
      
          if [ "$ENVIRONMENT" == "prod" ]; then
            echo "Executando SAST em ambiente de produção..."
            java -jar vosp-api-wrappers-java-24.7.14.0.jar \
              -vid $VID -vkey $VKEY \
              -action uploadandscan \
              -appname "${{ inputs.project_veracode }}" \
              -version "${{ github.run_id }}" \
              -filepath "$ARTIFACT" \
              -createprofile true \
              -deleteincompletescan 2 \
              -createsandbox false
          else
            echo "Executando SAST em ambiente de sandbox..."
            java -jar vosp-api-wrappers-java-24.7.14.0.jar \
              -vid $VID -vkey $VKEY \
              -action uploadandscan \
              -appname "${{ inputs.project_veracode }}" \
              -version "${{ github.run_id }}" \
              -filepath "$ARTIFACT" \
              -createprofile true \
              -deleteincompletescan 2 \
              -createsandbox true \
              -sandboxname "$ENVIRONMENT"
          fi
