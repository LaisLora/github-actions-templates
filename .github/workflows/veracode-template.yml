name: Veracode Analysis

on:
  workflow_call: # Permite ser chamado ap√≥s o build
    inputs:
      build-id:
        required: true
        type: string
jobs:
  environment-check:
    runs-on: ubuntu-22.04
    steps:
      - name: Verificar Ambiente
        run: |
          echo "üõ†Ô∏è Verificando ambiente..."
          uname -a
          echo "‚úÖ Ambiente pronto."
        
  
  autopack:
    needs: environment-check
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Baixar e Instalar CLI do Veracode
        run: |
          echo "üì• Baixando e instalando o CLI do Veracode..."
          curl -fsS https://tools.veracode.com/veracode-cli/install | sh

      - name: Empacotar Artefatos com o CLI do Veracode
        run: |
          # Diret√≥rio padr√£o dos artefatos gerados pelo build
          ARTIFACTS_DIR="${{ github.workspace }}"

          echo "üìÇ Diret√≥rio de artefatos definido como: $ARTIFACTS_DIR"
          
          # Validar se o diret√≥rio existe e cont√©m arquivos
          if [ ! -d "$ARTIFACTS_DIR" ] || [ -z "$(ls -A "$ARTIFACTS_DIR")" ]; then
            echo "‚ùå Diret√≥rio de artefatos inv√°lido ou vazio: $ARTIFACTS_DIR. Abortando."
            exit 1
          fi

          # Executar empacotamento diretamente na pasta padr√£o
          echo "üì¶ Empacotando artefatos do diret√≥rio $ARTIFACTS_DIR..."
          ./veracode package --source "$ARTIFACTS_DIR" --type directory --output "$ARTIFACTS_DIR/artifacts/analysisPack.zip" --trust

          # Validar o pacote gerado (opcional)
          if [ ! -f "/home/runner/work/Verademo2/Verademo2/artifacts/analysisPack.zip/verademo.war" ]; then
            echo "‚ùå O pacote n√£o foi gerado. Abortando."
            exit 1
          fi
          echo "‚úÖ Pacote gerado com sucesso: $ARTIFACTS_DIR/artifacts/analysisPack.zip"

      - name: Publicar Artefato
        uses: actions/upload-artifact@v3
        with:
          name: analysisPack
          path: ./artifacts/analysisPack.zip

      - name: Validar Pacote Gerado
        run: |
          if [ -f "./artifacts/analysisPack.zip" ]; then
            echo "‚úÖ Arquivo encontrado: ./artifacts/analysisPack.zip"
          else
            echo "‚ùå Arquivo n√£o encontrado. Abortando."
            exit 1
          fi

  Veracode_SCA:
    needs: autopack
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Veracode SCA
        env:
          SRCCLR_API_TOKEN: ${{ secrets.SRCCLR_API_TOKEN }} # Lembrar de criar as credenciais no Secrets
        run: |
          curl -sSL 'https://download.sourceclear.com/ci.sh' | bash -s ‚Äì scan --update-advisor --pull-request --allow-dirty         

  veracode-sast-pipeline_scan:
    needs: autopack
    runs-on: ubuntu-latest
    name: veracode pipeline scan

    steps:
      - name: checkout
        uses: actions/checkout@v4
      
      - name: download do artefato
        uses: actions/download-artifact@v3
        with:
          name: analysisPack

      - name: veracode pipeline-scan
        id: pipeline-scan
        uses: veracode/Veracode-pipeline-scan-action@v1.0.15
        with:
          vid: ${{ secrets.VERACODE_API_ID }}
          vkey: ${{ secrets.VERACODE_API_KEY }}
          file: './analysisPack.zip'

  veracode-sast-policy-scan:
    needs: [ autopack, veracode-sast-pipeline_scan ]
    runs-on: ubuntu-22.04
    steps:
      - name: Baixar Artefato
        uses: actions/download-artifact@v3
        with:
          name: analysisPack

      - name: Veracode SAST Policy Scan
        uses: veracode/veracode-uploadandscan-action@0.2.6
        with:
          appname: ${{ github.repository }}
          createprofile: true
          filepath: './analysisPack.zip'
          vid: ${{ secrets.VERACODE_API_ID }}
          vkey: ${{ secrets.VERACODE_API_KEY }}
          version: "${{ github.run_id }}"
          scantimeout: 12
